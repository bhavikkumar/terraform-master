language: generic
env:
  global:
  - TF_IN_AUTOMATION=1
  - VERSION="0.12.24"
  - AWS_DEFAULT_REGION=us-east-1
  - secure: t4LhmgOPfy88KkIUSduAWiDwLXN0IM8CsO4zlrFRFvb6HxaVnJi6Q23cO5TfIl3yhrCMiQTmjwOLjnm/9eFyk+tgWRxRrPQVs5RoQ/WQPHsdEubxyhtAK0ENfKOHSN5GVE5q1QaNHB03Zs6azN3NmV+mFnXRJh6l8QViSFcnRF4rQyijgbmoLGKlzblj52y1h2q0MXmYs/MF5HWtgYk6j5gBJ+NTKlX1CnUkIo+8vsdK7bvqbY3/zaFREWAv7urDCzllvq4a7q1Ma0dzAnGOK8oIP32G7Wy63WBDlH/+PuZEOgNIF9yof7pHdc86mI00hBXCtPIaEDp0996OF33yOVkH0KDBvSjqgxjGd9B/Tb0QYO2Otv9gqp3GEuIgiBVN4SQQuqIlE1YBSPGKrWKadZGxZgoUhtesEVrpsziV6ThRCliZkuSv4eFZtKEqiPVHYwcR26BV7W7EY99ojVKtSoq52onlJC6hLjId0YoHvXq0Hw+vOFKJxNRQdtZYK5vUd6vfVNgqwF/LJvZhqErWTvzjskEk50JUmAF+tY4l2gFw3eK/SuQzDBvFiGLL/AmaHgEc7G8g4SYmpjeB9K+PxtGiiznE6Z6kgBJP262lemtbW1xsZrOTqGAtsDwTBE4UKYIV6BOHSxNsaToZ803LQeSSlSGJonnOwjxpNnVPfcY=
  - secure: seidbRs55Xd9hkvqmcEbzVaAzhzAHVjYzKg4RHzXtCuEyYZBzv37ZXjI8jN3zVgtop7WOS9k9h1dFBp8dbrrqBdGJQ2MgcMjwVEGfXAMJvUrqgjZLEa3YXzW4TbWzyTtyBflQ9DWlPxm2hhtq7/d2fQDoYtnR1bLQxrpWDHXD8pITNPkIZf4iLpJg/808r7NvnpKFaoM0CA0f+vqPDTDO2PSF+1rVlz9dta2Twlh/KgTlmJ+1mJExvaOAZLQnjzrvDmA5soZvoH5wQSBrrrALRYNOA4ihMMP4ML1g9gheKwMsw5JqSMsVmv2hFqyTQtxH2PgNJCEsjW/hOvGqiR3emShQ97PdTYjkKNOrHCxios/R6X9pux1Es2xhdXENT587ucXZlPhntXeKGl+BhX8pCZUGFUv4YQwptgpe+7/GC/8iuRGRjvMjCfbCKahwqOKmwqaIWA6ENGqXek5j/a+1KWtpoDuKOk63PqglRGEwfsRyKutxfywsHHm0RTREvaTf2iyc203fuzc2eJss85J9U+ax2HuUHZK+BBN4ufwAfQTBkcLPJagjMM4gw+Y+7+KJ4FcMt0GWERRyRXYXViAtw49FCnPpVwrwir/qq6vR+P4tZXW+NIVMxdiEnx7QXbK/Gl4B5bhuhzvXLa9mISNOPAY1mJxxxvBifS9oA/+Aio=
  - secure: GW22k4rdLaLp//Eb0MGxRVKrqvt1mVjyBpLiwKNcYljFzh2zXWoOhUxs06z1TpW/NxZ4bKxPVHt65D59Bmq/boGDdBLHIJCGuouHDhFQYK4zpi/pLEbGXGvOXT8qlsTybzlBUAJKwXnD6/Q5jAC6H9Ik59IApuBdi+gA7MJMCS4EGkgp7551t/4ozU/IQ9U2OSZ2O2gCy5pBBgPwss9hdLgTfPb0RXw7pmwznjzep54htTBs3oXhms6WxR0LLdkGCkJK8I4EGfeyhFUgnjd1hgNMnIm73Hl+GHVOuvnZw4jOqtZAIyqntGjuLymf8G/WTX7hCeOU74VGUbwhyugw+VVef/U//CVAWzI3eyBtBALF58X+hLaAVLYxIiPiiaQf8+g3cvOOfxLBZV3Owt4WL18/2hjY7+abZiqOZoLMNI2Ajn8o30EePcDREn4VW7dxEEm7U4UDlp+karTJWYC+9mMUVoWZL3+Bx3qTU1P0cwNb3k5d9l4lzTeh08vF6AlYjyRWWpy6h+TYKnsUnpyr9mY932TjytCsZh1iAJqOT/e7ZGHDkbN5z4r7Xgb9/oUMAcGPZxOQ3jq1gUR/ZhzZ31+n0+HHwtBJOYqYir8iQtpEx0C04yQ640Tk+z7B423E1sG/fq4hhpVsN9VVCZSudP8u5DYuo9LYrnO5e8DcuAY=
  - secure: gxG864z0FwjlgF7B6HSsbHTwMg+nU9aFMJ2V9dExzWdrHQa5TNcXDhxmczkoIfko92nbMydO5QMiYx6MFvKK4oiVm/SRx44FURZvXsjXm7U08eVVSMUcPtNJqNYKRc7z9cAUejd3pFN+gyaBDPilnhYK/7GZ25/4HwGKTV3LhLIOAV5jnsL3v5Urt1VlqD8/kGoFMl1Ii9M65Oz/poL7p7Tjninl6vEj+s1rZZHkc5ofsk2KEqBy8vebUgsTO1xyJEqhmLZMiH6dHvSpIso1WJ8dwt7dZGFjkaaoCCLGQxzG20Im0eaiZDPROlI0i/qhDRjEw+hYB9C7JT7XApsky+/55yaJtfz/uLF+DYtDZTuM58KCIFWV5JJdYldaMQ+vxiufj7RogLH2spnA83ZERSqcIRLF5GUcdiYV+R8lJdG+NjiZ3wK3/SyHVJ7ZK8pzOaJN1kET+N0ESxtUm+ZfmIlMtI7HXkwymvHub9jtbxKvmqa/l4BUYLOJ+Ft8StW0oOkJMA1P5l9OLySzPkGBORHqW/9n1ienUsuTQIsFADD3vlplEKwqU+XAiB7laP2eJzN3DfokKW8FCrrz16I49uouUIiFkGWdhEBKs6NbNPUGQlJGhGqbqglwd3gl3nSpu1QQtk7DwHyBDRbTgHXho/5XPr4ful4Un//SjFg2WzM=
  - secure: Rw/+yRim9VszWk0Rh6HEyIwmPdHP0+IZ6qOelULGs0IoMdV3FHdXcwlUdKd79OVR3KJik5rr4q9gonIRMb78I3JO44B7jc8tTz3fcvk3Gc/qUGdwdmdVZhmd7jfU/fZJX/Lr38+ynmB7dElVNchRGDwTmgJxe27tdR4aDCvhf7LXNRvq/P5c6qg3hzCKctgDdSC65z8l5p6m9QWclvEVHIO1931KbxSBEsnpVblj9/etBMIJDN847wt4Uigfd2rmxJ1pUQ+FD1Q815/RMfRhPZx2gVwfQsThfZlC4Z2PHL1e2pWdyNPzlz6GA6fUfyZiYEyALXrjHiItI0mDesIjYdOriWblDqPedIb4P4w4YCTDibAvQK+B48pH29Vemdh/IAHDQlIGLgkaH602WGyCVB2FrDH9SgKm8VRFJ2vBmhX0C+EqVdS1trOhnsw8ftaidqaVUrZt0UWyhcE/qajpfzP98Gychfs0Xu2NfQQf8XEsO+EaWsMJ4Am9GC7rLqHDMlWMCIMLtTujjUDt9Z+PiaJBt09YU4F51oW6R0HWA8wZS8tVZOhkpQXOmheB3tql7dakhl+caglaJotqQeMmUPO5IYmj8rMi2xnzvme70zV8XNwSa3Jm+lPpLmTs6lbV5lHjLk0dbsz4NIrEsrpV/3MOrhp9XeGsUrWoP3rZo5Y=
before_install:
- wget https://releases.hashicorp.com/terraform/${VERSION}/terraform_${VERSION}_linux_amd64.zip
- unzip terraform_${VERSION}_linux_amd64.zip
- chmod +x terraform
script:
- ./terraform init -backend-config="bucket=terraform.bhavik.io" -backend-config="region=${AWS_DEFAULT_REGION}" -backend-config="dynamodb_table=terraform-state" -backend-config="kms_key_id=${KMS_KEY_ID}" -backend-config="role_arn=${ROLE_ARN}" >/dev/null
- ./terraform plan -input=false -var account_prefix=mahameru -var domain_name=bhavik.io -var master_account_id=${AWS_ACCOUNT_ID} -var aws_default_region=${AWS_DEFAULT_REGION} >/dev/null
deploy:
- provider: script
  script: ./terraform apply -backup="-" -input=false -auto-approve -var account_prefix=mahameru -var domain_name=bhavik.io -var master_account_id=${AWS_ACCOUNT_ID} -var aws_default_region=${AWS_DEFAULT_REGION} >/dev/null
  skip_cleanup: true
  on:
    branch: master
